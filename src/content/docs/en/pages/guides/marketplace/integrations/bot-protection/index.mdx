---
title: How to install Azion Bot Protection from Azion Marketplace
description: The Azion Bot Protection analyzes incoming requests using edge functions on Edge Firewall, assigning a score based on rules and behaviors to detect and prevent malicious activities.
meta_tags: bot, protection, cybersecurity, edge computing
namespace: docs_use_case_bot_protection
permalink: /documentation/products/guides/bot-protection/
---

Azion **Bot Protection** is a *serverless* integration available at **Azion Marketplace**. It analyzes incoming requests using an edge function running on **Edge Firewall** and assigns a score based on rules and behaviors. If the score exceeds a predetermined threshold, the integration declines or cancels the request. 

Using advanced algorithms that analyze the behavior of incoming data, the integration can detect and prevent malicious activities such as credential stuffing, vulnerability scanning, and site scraping.

The system employs *Reputation Intelligence* to establish a profile of each person who visits the site, including location, device type, and browsing patterns. This enables the prompt detection of suspicious behavior and the implementation of preventive measures against potential threats.

import Button from '~/components/Button.astro';

<Button href="/en/documentation/products/marketplace/bot-protection/" text="go to Bot Protection reference" variant="secondary"> 

</Button>

---

## Getting the integration

To use Azion **Bot Protection**:

1. Access [Real-Time Manager (RTM)](/en/documentation/products/guides/how-to-access-rtm/) > **Marketplace**.
2. On the Marketplace's homepage, select the integration's card.
3. Once the integration's page opens, click the **Get It Now** button, at the bottom-right corner of the page.
 
A successful message appears to confirm your integration is installed.

:::tip
You can search any integration by browsing through the cards or typing a keyword in the search bar. 
:::

---

## Configuring the integration

### Setting up the Edge Firewall 

To instantiate Azion **Bot Protection**, follow the steps:

1. On the upper-left corner, select **Products menu** > **Edge Firewall** in the **SECURE** section.
2. Click the **Add Rule Set** button.
3. Give an easy-to-remember name to your new rule.
4. Select the domains you want to protect with the function.
5. Enable the **Edge Functions** switch in the **Edge Firewall Modules** section.
6. Click the **Save** button.

Done. Now you've instantiated the rule for your function and have access to edge functions on your edge firewall.

:::caution[Warning]
If a product or module is activated, it could generate usage-related costs. Check the [pricing page](https://www.azion.com/en/pricing/) for more information.
:::

### Setting up the function

While still on the **Edge Firewall** page:

1. Select the **Functions** tab.
2. Click the **Add Function** button.
3. Give an easy-to-remember name to your instance.
4. On the dropdown menu, select the **Azion Bot Protection** function.

This action will load the function, showing a form with the function code and, just above it, two tabs: **Code** and **Args**.

On the **Args** tab, you'll pass your variables.

```json
{
  "threshold": 10,
  "action": "deny"
}
```

Even when `threshold` and `action` are mandatory variables to be defined, you can add and define more variables, according to your needs, as shown in the example below:

```json
{
  "threshold": 10,
  "action": "deny",
  "disabled_rules": [],
  "reputation_network_lists": [2357, 2358, 2358, 2360],
  "log_tag": "log_tag",
  }
```

Where:

| Variable | Type | Required | Description |
|---|---|---|---|
| `threshold` | Number | Yes | The maximum score that the request can reach before the function takes an action. If it has no value, the function won't take action |
| `action` | String | Yes | The action to be taken by the function whenever the request's score is greater or equals the defined threshold. Possible values: `deny`, `redirect`, `custom_html`, `drop`, `log`, `random_delay`, and `hold_connection`. Read more about [configuring actions](#configuring-actions) |
| `log_tag` | String | No | A tag to identify the function instance which generated the request |
| `log_all_headers` | Boolean | No | Defines whenever or not all the request headers should be sent in the function's log. **Note**: the headers' values are going to be printed with base64 encode |
| `disabled_rules` | Array of numbers | No | The rules to be disabled. If a rule is disabled, it won't be processed nor increment the request score |
| `reputation_network_lists` | Array of numbers | No | Every network list that should be used to validate the request IP. If the request IP is found in a list, then the request score will be increased. If the request IP is found in multiple lists, the score will be increased by multiple times |
| `session_signature_key` | String | No | To sign the `az_asm`. If this field has no value or an invalid value, the function will use the default value `azion` |

5. When you're done, click the **Save** button.

:::tip
To learn about the possibilities to set up Bot Protection, go to the [Defining use cases](#defining-use-cases) section, including [how to get logs](#logs).
:::

### Setting up the Rules Engine

To finish, you have to set up a **Rules Engine** to configure the *behavior* and the *criteria* to run the function.

Still in the **Edge Firewall** page:

1. Select the **Rules Engine** tab.
2. Click the **New Rule** button.
3. Give an easy-to-remember name to the rule.
   - You can add a description, but it's an optional step.
4. Select a *criteria* to run and catch the domains that you want to run the integration on.
    - Use this rule: `if Request URI does not match "\.(png|jpg|css|js|jpeg|gif|ico|ttf|svg|woff|woff2|ashx|asmx|svc|swf|otf|eot)(\?.*)?$"`
        - This rule is necessary to exclude all static data on your application.
5. You have to create another criteria for this integration to work: `if Request URI does not match /.well-know/`
    - This rule is necessary to create a list of allowed IPs that doesn't impact automation or scripts to WEB API.
6. Below, select a *behavior* to the *criteria*. In this case, it'll be **Run Function**.
7. Select the adequate function according to the name you gave it in the instantiate step.
8. Click the **Save** button.

Done. You now have your domains protected against bot attacks by using Azion **Bot Protection**.

---

## Defining use cases

Azion will provide you with easy-to-go configurations, that should be enough for most of the cases. If you need a more detailed configuration, such as custom rules, you can edit the `JSON` file for the integration.

To find this file:

1. On the upper-left corner, select **Products menu** > **Edge Firewall** in the **SECURE** section.
2. Select the one related to **Bot Protection**.
3. Open the **Functions** tab to load the integration's source-code form.
4. Select the **Args** tab.

This will load a `JSON` file where you'll be able to tune **Azion Bot Protection** according to the necessities of your business.

<Button href="/en/documentation/products/guides/secure/manage-bots/" text="go to manage bots guide" variant="secondary"> 
</Button>

### Configuring actions

Azion **Bot Protection** is able to execute **7 different actions** whenever the request's score is greater than or equals the defined threshold. Read more about each one below:

1. `allow`: allows the continuation of the request. To enable this action, you must declare it as follows:

```json
  "action": "allow"
```

This action doesn't require any additional arguments.

2. `deny`: delivers a standard *Status Code 403* response. To enable this action, you must declare it as follows:

```json
  "action": "deny"
```

This action doesn't require any additional arguments.

3. `drop`: terminates the request without a response to the user. To enable this action, you must declare it as follows:

```json
  "action": "drop"
```

This action doesn't require any additional arguments.

4. `redirect`: allows the request to be redirected to a new URL/location when the security threshold is reached. To enable this action, you must declare the variables as in the example:

```json
  "action": "redirect",
  "redirect_to": "http://xxxxxxxxxx.map.azionedge.net/"
```

Where `redirect_to`: defines the new URL/location to redirect the requests. If this field isn't filled or filled with a value that isn't a *string*, the function will behave as if the `allow` action was enabled.

5. `custom_html`: allows customized HTML content to be delivered to the user in case of a threshold violation. To enable this action, you must declare the variables as in the example:

```json
  "action": "custom_html",
  "custom_html": "This should be the custom HTML content",
  "custom_status_code": 418,
```

Where `custom_html` defines the HTML content to be delivered and `custom_status_code` the status code to be delivered.

- If `custom_html` isn't filled or it's filled with a value that isn't a *string*, the function will behave as would happen with the `allow` action enabled.
- If `custom_status_code` isn't filled or it's filled with a value that isn't a *number*, the default value will be a *Status Code 200*.

6. `random_delay`: makes the function wait for a random period between *1* and *10* seconds before allowing the request to proceed. To enable this action, you must declare it as follows:

```json
  "action": "random_delay"
```

This action doesn't require any additional arguments.

7. `hold_connection`: holds the request, keeping the connection open for *1 minute* before dropping it. To enable this action, you must declare it as follows:

```json
  "action": "hold_connection"
```

This action doesn't require any additional arguments.

### Bot Protection modes

Azion **Bot Protection** allows you to define the environment in which the function is expected to run. The possible modes are *API* or *web application*.

The default mode is `web`. If any value other than the string "api" (case-sensitive in lowercase) is provided, the "web" mode will be used.

By enabling the `api` mode, no "Set-Cookie" will be performed, and any rules related to the use of cookies in Bot Protection will be ignored. To set this mode, add the following variables in the JSON Args:

```json
"mode": "api",
```
:::note
This variable is sent to the SIEM logs.
:::

### Custom field

This feature allows extracting a user identifier from the request and adding it to the execution report log. The configuration for capturing this identifier, which is optional, can be done through the following keys in the JSON Args:

```json
"custom_field_source": "args",
"custom_field_name": "uid",
```

Where:

- `custom_field_source`: the source to extract the data to create the user ID for the request. Possible values (case-sensitive in lowercase):
  - `args` (querystring)
  - `cookie`
  - `header`
  - `body` (request body): only bodies in the `application/json`, `application/x-www-form-urlencoded`, and `multipart/form-data` formats are accepted
- `custom_field_name`: defines the name of the `user_id_source`. Example: `uid`

In the following example, the user ID would is being extracted from the `uid` argument in the query string.

```
v2      2023-11-30T13:09:14+00:00       1531930033      local   1576596497      1       04235e2ff3b0ee52c9f8af51589eeb45        CONSOLE LOG     [Bot-Protection][rule] Report:  {"request_id":"04235e2ff3b0ee52c9f8af51589eeb45","remote_addr":"172.18.0.1","host":"localhost","method":"GET","http_user_agent":"curl/8.1.2","request_uri":"/","geoip_country":null,"geoip_region":null,"asn":null,"score":0,"bot_category":[],"classified":"legitimate","action":"allow","custom_field":"my_user","matched_rules":[]}
```
### Fingerprint

By using the Fingerprint integration, a set of information (IP, User-Agent header) creates a hash for devices accessing your edge applications. The information is gathered by tracing the device's session and provides a more accurate detailing of the request's device, increasing the precision of Bot Protection logs.

If you've already install the Fingerprint integration, you can call the unique identifier of the request in the JSON Args for Bot Protection, using a boolean, as follows:

```json
"fingerprint": "true"
```

The default value is `false`.

<Button href="/en/documentation/products/guides/fingerprint/" text="go to how to install fingerprint guide" variant="secondary"> 
</Button>

### Logs

#### Using Real-Time Metrics

At Azion, you can monitor application's behavior through the [Observe](/en/documentation/products/observe/overview/) products: **Real-Time Metrics**, **Real-Time Events**, **Data Streaming** and **Edge Pulse**. 

If you use Fingerprint with Bot Protection, you can also enable the use of Azion [Real-Time Metrics](/en/documentation/products/observe/real-time-metrics/) to query consolidated data via [GraphQL API](/en/documentation/devtools/graphql-api/overview/) related to the access to the application protected by Bot Protection, facilitating the identification of patters and *use this intelligence to optimize your rules*.

The function calls twice to the GraphQL API, to retrieve usage data for the protected host and then to fetch usage data for the fingerprint making the request. In each call, the medians of the last 15 minutes of application usage are returned: 

- `countryVariation`
- `customFieldVariation`
- `errorRate`
- `frequencyRate`
- `headRequestFrequencyRate`
- `postRequestFrequencyRate`
- `requestCount`
- `requestUriVariation`
- `uniqueRequestUriCount`
- `uniqueCountryCount`
- `uniqueCustomFieldCount`
- `uniqueRemoteAddressCount`

Using this data and the fingerprint, the function validates if the usage can be identified as a possible attack, including: brute force, scrapping, crawling, credential stuffing, and account takeover. In case of being identified as an attack, the function trigger the defined action and also add the attack type, besides the type of bot (Bad bot, for example) to the logs.

Additionally, you can define the **sensitivity** of the integration to analyze the data and the fingerprint, being the possible values:

- **Soft**: defines a lower criticality.
- **Medium**:  intermediate criticality.
- **Hard**: defines a higher criticality.

To enable this feature, include the following variables in the JSON Args:

```json
"metrics_disabled": false,
"metrics_logs": true,
"metrics_token": "azionb9d87fe9f5758c183bf2e63f15eb5aa5dfd",
"metrics_session_threshold": "hard",
```
Where:

| Variable | Type | Required | Description |
|---|---|---|---|
| `metrics_disabled` | Boolean | No | When activated, it prevents validation against the API from being performed. Default value: `false` |
| `metrics_logs` | Boolean | No | When enabled, logs related to the execution of the API are recorded in the Azion Real-Time Events. Default value: `false` |
| `metrics_token` | String | Yes,<br/> with `metrics_bypass` enabled  | Azion Personal Token to be used in GraphQL API requests. Default value: `"null"` |
| `metrics_session_threshold` | String | No | Defines the sensitivity to analyze the data and the fingerprint. Possible values: `"soft"`, `"medium"`, and `"hard"`. Default value: `"soft"` |

:::note
In case of downtime, delay, or invalid JSON Args, the GraphQL API will return a error message. When there's no data for the host and fingerprint, the integration recognizes the request as legitimate and the function execution proceeds as usual.
:::

#### Integrating with a SIEM

If you require the Bot Protection logs, you may join a SIEM platform to obtain full data. To do so, in the **Arguments** tab, update the function and put in the SIEM connection data.

##### SIEM connection example

```json
{
"siem_integration": true,
  "send_data_to_siem_when": "always",
  "siem_connection_args": {
    "host": "example.com",
    "uri": "/inspect/01g43ftztkqgvcr65pjwbr0227",
    "port": "443",
    "scheme": "https",
    "additional_headers": {
      "Authorization": "secret123"
      }
   }
```

Where:

| Variable | Type | Required | Description |
|---|---|---|---|
| `siem_integration` | Boolean | No | Defines if the request data should perform POST to an external endpoint. Default value: `false` |
| `send_data_to_siem_when` | String | Yes, <br/> with `siem_integration` enabled | Defines when the request data should be sent to the external endpoint. Possible values: `always`, `deny`, `redirect`, `custom_html`, `drop`, `log`, `random_delay`, and `hold_connection`. Read more about [configuring actions](#configuring-actions) |
| `siem_connection_args` | Table | Yes, <br/> with `siem_integration` enabled | The arguments to be used in the POST to the external endpoint |
| `siem_connection_args.host` | String | Yes,<br/> with `siem_integration` enabled | The host where the data will be POSTed to. If this field is empty, the function will be bypassed |
| `siem_connection_args.uri` | String | No | The URI where the data will be POSTed to. Default value: `/`  |
| `siem_connection_args.port` | Number | No | The port where the data will be POSTed to. Default value: `443` |
| `siem_connection_args.scheme` | String | No | Defines the scheme to be used in the POST. Default value: `https` |
| `siem_connection_args.additional_headers` | Table | No | Additional headers to be sent in the POST. The function will always send the following headers: `["Accept"] = "application/json"`, `["Content-Type"] = "application/json"` |

##### Log example

When logs are sent to the SIEM, you'll receive the following information:

```json
{
  "geoip_region": "SP",
  "action": "deny",
  "asn": "396982",
  "request_id": "9581e2b51b5a082b12fed308f4eae564",
  "host": "xxxxxxx.map.azionedge.com",
  "classified": "bad bot",
  "geoip_country": "BR",
  "http_user_agent": "curl/7.87.0",
  "bot category": [
    "Bad Bot Signatures"
  ],
  "request_uri": "/a",
  "remote_addr": "34.95.175.91",
  "score": 8
}
```

---

import ContributorList from '~/components/ContributorList.astro'

**Contributors** <ContributorList>Contributor</ContributorList>
