---
title: Como instalar o Azion Bot Protection através do Marketplace da Azion
description: Azion Bot Protection é uma integração serverless que utiliza edge functions no Edge Firewall para analisar requisições recebidas e atribuir uma pontuação com base em regras e comportamentos e prevenir possíveis ataques.
meta_tags: bot, protection, cibersegurança, edge computing, SIEM
namespace: docs_use_case_bot_protection
permalink: /documentacao/produtos/guias/bot-protection/
---

Azion **Bot Protection** é uma integração *serverless* disponível no **Marketplace da Azion**. Esta integração analisa requisições recebidas usando uma edge function, executada no **Edge Firewall**, e atribui uma pontuação com base em regras e comportamentos.

Se a pontuação exceder um limite predeterminado, a integração declina ou cancela a requisição. Usando algoritmos avançados que analisam o comportamento dos dados recebidos, ela pode detectar e impedir atividades maliciosas, como preenchimento de credenciais, varredura de vulnerabilidades e *site scraping*.

O sistema emprega o algoritmo de *Reputation Intelligence* a fim de estabelecer o perfil de cada pessoa que visita o site, incluindo localização, tipo de dispositivo e padrões de navegação. Isso permite a identificação instantânea de comportamentos suspeitos e, assim, ações preventivas contra possíveis ataques.

import Button from '~/components/Button.astro';

<Button href="/pt-br/documentacao/produtos/marketplace/bot-protection/" text="saiba mais sobre o Bot Protection" variant="secondary"> 

</Button>

---

## Obtenha a integração

Para obter a integração:

1. Acesse o [Real-Time Manager (RTM)](/pt-br/documentacao/produtos/guias/como-acessar-o-rtm/) > **Marketplace**.
2. Na página inicial do Marketplace, selecione o card correspondente à integração Azion **Bot Protection**.
3. Quando estiver na página da integração, clique no botão **Get It Now**, no canto inferior direito.

Uma mensagem aparecerá indicando que a integração foi instalada com sucesso.

:::tip
Você pode procurar qualquer integração navegando pelos cards ou digitando uma palavra-chave na barra de busca.
:::

---

## Configure a integração

### Configure o Edge Firewall

Para instanciar a integração Azion **Bot Protection**, siga estes passos:

1. No canto superior esquerdo do RTM, selecione **Products menu** > **Edge Firewall**, dentro da seção **SECURE**.
2. Clique no botão **Add Rule Set**.
3. Dê um nome fácil de lembrar à sua nova regra.
4. Selecione os domínios que deseja proteger com a função.
5. Habilite o switch **Edge Functions** na seção **Edge Firewall Modules**.
6. Clique no botão **Save**.

Pronto. Você instanciou a regra para sua função e habilitou o uso de edge functions para seu edge firewall.

:::caution[Atenção]
Se qualquer produto ou módulo for ativado, pode gerar custos relacionados ao uso. Consulte a [página de preços](https://www.azion.com/pt-br/precos/) para obter mais informações.
:::

### Configure a função

Ainda na página do **Edge Firewall**:

1. Selecione a aba **Functions**.
2. Clique no botão **Add⁠ Function**.
3. Dê um nome fácil de lembrar à sua instância.
4. No menu suspenso, selecione a função **Azion Bot Protection**.

Esta ação carregará a função, mostrando um formulário com o código-fonte desta e, logo acima dele, duas abas: **Code** e **Args**.

Na aba **Args**, você passará suas variáveis.

```json
{
  "threshold": 10,
  "action": "deny"
}
```

Mesmo quando `threshold` e `action` são as variáveis obrigatórias, você pode adicionar e definir mais variáveis, de acordo com sua necessidade, conforme mostrado no exemplo a seguir:

```json
{
  "threshold": 10,
  "action": "deny",
  "disabled_rules": [],
  "reputation_network_lists": [2357, 2358, 2358, 2360],
  "log_tag": "log_tag",
}
```

Onde:

| Variável | Tipo | Obrigatório | Descrição |
|---|---|---|---|
| `threshold` | Número | Sim | A pontuação máxima que a requisição pode atingir antes que a função execute uma ação. Se não tiver valor, a função não agirá |
| `action` | String | Sim | A ação a ser tomada pela função sempre que a pontuação da requisição for igual ou maior ao limite definido. Valores possíveis: `deny`, `redirect`, `custom_html`, `drop`, `log`, `random_delay` e `hold_connection`. Saiba mais sobre a [configuração de actions](#configuracao-de-actions) |
| `log_tag` | String | Não | Uma tag para identificar a instância da função que gerou a requisição |
| `log_all_headers` | Boolean | Não | Define quando ou não todos os cabeçalhos da requisição devem ser enviados no log da função. **Nota**: os valores dos cabeçalhos serão impressos com codificação base64 |
| `disabled_rules` | Array de números | Não | As regras a serem desativadas. Se uma regra estiver desabilitada, ela não será processada nem aumentará a pontuação da requisição |
| `reputation_network_lists` | Array de números | Não | Todas as network lists que devem ser usadas para validar o IP da requisição. Se o IP da requisição for encontrado em uma lista, a pontuação da requisição aumentará. Se for encontrado em várias listas, a pontuação será aumentada várias vezes |
| `session_signature_key` | String | Não | Para assinar o `az_asm`. Se este campo não tiver valor ou tiver um valor inválido, a função usará o valor padrão `azion` |

5. Quando estiver pronto, clique no botão **Save** para salvar suas configurações.

:::tip
Para saber sobre as possibilidades de configuração e uso do Bot Protection, acesse a seção [Defina use cases](#defina-use-cases), que inclui [como obter os logs](#logs)
:::

### Configure o Rules Engine

Para concluir, você precisa configurar o **Rules Engine** e nele configurar o *behavior* (comportamento) e os *criteria* (critérios) para executar a integração.

Ainda na página **Edge Firewall**:

1. Selecione a aba **Rules Engine**.
2. Clique no botão **New Rule**.
3. Dê um nome fácil de lembrar à sua nova regra.
   - Você pode adicionar uma descrição, mas é um passo opcional.
4. Selecione um *criteria* (critério) para executar a integração:
   - Use esta regra: `if Request URI does not match "\.(png|jpg|css|js|jpeg|gif|ico|ttf|svg|woff|woff2|ashx|asmx|svc|swf|otf|eot)(\?.*)?$"`
      - Esta regra é necessária para excluir todos os dados estáticos.
5. Você precisa criar outro critério para que esta integração funcione: `if Request URI does not match /.well-know/`
   - Essa regra é necessária para criar uma lista de permissões de IP que não impacte a automação ou scripts da WEB API.
6. Abaixo, selecione o *behavior* (comportamento) para os *criteria* (critérios). Nesse caso, será **Run Function**.
7. Selecione a função **Azion Bot Protection** de acordo com o nome que você deu antes.
8. Clique no botão **Save**.

Pronto. Agora você tem seus domínios protegidos contra ataques de bot usando a integração Azion **Bot Protection**.

---

## Defina use cases

A Azion fornecerá configurações básicas e fáceis de usar, que devem ser suficientes para a maioria dos casos. Se você precisar de uma configuração mais detalhada, como regras personalizadas, você pode editar o arquivo `JSON` da integração.

Para encontrar esse arquivo:

1. No canto superior esquerdo do RTM, selecione **Products menu** > **Edge Firewall**, dentro da seção **SECURE**.
2. Selecione o relacionado com **Bot Protection**. 
3. Abra a aba **Functions** para carregar o formulário contendo o código-fonte da integração.
4. Selecione a aba **Args**.

Isso carregará um arquivo `JSON` onde você poderá ajustar os parâmetros de acordo com as necessidades do seu negócio.

<Button href="/pt-br/documentacao/produtos/guias/secure/gerenciar-bots/" text="consulte o guia sobre gerenciar bots" variant="secondary"> 
</Button>

### Configuração de actions

Azion **Bot Protection** é capaz de executar **7 ações diferentes** sempre que a pontuação da requisição for maior ou igual ao limite (threshold) definido. Saiba mais sobre cada action a seguir:

1. allow`: permite a continuação da solicitação. Para habilitar esta ação, você deve declará-la da seguinte forma:

```json
  "action": "allow"
```

Essa ação não requer argumentos adicionais.

2. `deny`: entrega uma resposta padrão com *Status Code 403*. Para habilitar esta ação, você deve declará-la da seguinte forma:

```json
  "action": "deny"
```

Essa ação não requer argumentos adicionais.

3. `drop`: encerra a requisição sem uma resposta ao usuário. Para habilitar esta ação, você deve declará-la da seguinte forma:

```json
  "action": "drop"
```

Essa ação não requer argumentos adicionais.

4. `redirect`: permite que a requisição seja redirecionada para uma nova URL/localização quando o limite de segurança é atingido. Para habilitar esta ação, você deve declarar as variáveis como no exemplo:

```json
  "action": "redirect",
  "redirect_to": "http://xxxxxxxxxx.map.azionedge.net/"
```

Onde `redirect_to` define a nova URL/localização para redirecionar as requisições. Se este campo não estiver preenchido ou estiver preenchido com um valor que não seja uma string, a função se comportará como aconteceria com a ação `allow` habilitada.

5. `custom_html`: permite a entrega de conteúdo HTML personalizado ao usuário em caso de violação do limite. Para habilitar esta ação, você deve declarar as variáveis como no exemplo:

```json
  "action": "custom_html",
  "custom_html": "This should be the custom HTML content",
  "custom_status_code": 418,
```

Onde `custom_html` define o conteúdo HTML a ser entregue e `custom_status_code` define o status code a ser entregue.

- Se `custom_html` não estiver preenchido ou estiver preenchido com um valor que não seja uma string, a função se comportará como aconteceria com a ação `allow` habilitada.
- Se `custom_status_code` não estiver preenchido ou estiver preenchido com um valor que não seja um número, o valor padrão será um *Status Code 200*.

6. `random_delay`: faz com que a função espere por um período aleatório entre `1` e `10` segundos antes de permitir que a requisição prossiga. Para habilitar esta ação, você deve declará-la da seguinte forma:

```json
  "action": "random_delay"
```

Essa ação não requer argumentos adicionais.

7. `hold_connection`: "reném a requisição, mantendo a conexão aberta por *1 minuto* antes de encerrá-la. Para habilitar esta ação, você deve declará-la da seguinte forma:

```json
  "action": "hold_connection"
```

Essa ação não requer argumentos adicionais.

### Bot Protection modes

Azion **Bot Protection** permite que você defina o ambiente em que a função deve ser executada. Os modos possíveis são *API* ou uma *aplicação web*.

O modo padrão é `web`. Se for fornecido qualquer valor que não seja a string "api" (sensível a maiúsculas e minúsculas), o modo "web" será utilizado.

Ao habilitar o modo `api`, nenhum "Set-Cookie" será realizado, e quaisquer regras relacionadas ao uso de cookies no Bot Protection serão ignoradas. Para configurar este modo, adicione as seguintes variáveis no JSON Args:

```json
"mode": "api",
```

:::note
Essa variável é enviada nos logs do SIEM.
:::

### Custom field

Essa funcionalidade permite extrair um identificador de usuário da requisição e adicioná-lo ao log de execução do relatório. A configuração para capturar esse identificador, que é opcional, pode ser feita por meio das seguintes chaves no JSON Args:

```json
"custom_field_source": "args",
"custom_field_name": "uid",
```
Onde:

- `custom_field_source`: a fonte para extrair os dados e criar o ID do usuário para a requisição. Valores possíveis (sensíveis a maiúsculas e minúsculas):
  - `args` (query string)
  - `cookie`
  - `header`
  - `body` (body da requisição): apenas bodies nos formatos `application/json`, `application/x-www-form-urlencoded` e `multipart/form-data` são aceitos
- `custom_field_name`: define o nome da `user_id_source`. Exemplo: `uid`

No exemplo a seguir, o ID do usuário está sendo extraído do argumento uid na query string.

```
v2      2023-11-30T13:09:14+00:00       1531930033      local   1576596497      1       04235e2ff3b0ee52c9f8af51589eeb45        CONSOLE LOG     [Bot-Protection][rule] Report:  {"request_id":"04235e2ff3b0ee52c9f8af51589eeb45","remote_addr":"172.18.0.1","host":"localhost","method":"GET","http_user_agent":"curl/8.1.2","request_uri":"/","geoip_country":null,"geoip_region":null,"asn":null,"score":0,"bot_category":[],"classified":"legitimate","action":"allow","custom_field":"my_user","matched_rules":[]}
```

### Fingerprint

Ao usar a integração Fingerprint, um conjunto de informações (IP, cabeçalho User-Agent) cria um hash para dispositivos que acessam suas edge applications. As informações são coletadas rastreando a sessão do dispositivo e fornecem um detalhamento mais preciso do dispositivo usado na requisição, aumentando a precisão dos logs do Bot Protection.

Se você já instalou a integração de Fingerprint, pode chamar o identificador único da requisição nas JSON Args do Bot Protection, usando um booleano, da seguinte forma:

```json
"fingerprint": "true"
```

O valor padrão é `false`.

<Button href="/pt-br/documentacao/produtos/guias/fingerprint/" text="consulte o guia para instalar fingerprint" variant="secondary"> 
</Button>

### Logs

#### Use Real-Time Metrics

Na Azion, você pode monitorar o comportamento das aplicações por meio dos produtos [Observe](/pt-br/documentacao/produtos/observe/visao-geral/): **Real-Time Metrics**, **Real-Time Events**, **Data Streaming** e **Edge Pulse**.

Se você utiliza o Fingerprint junto com o Bot Protection, também pode habilitar o uso do [Real-Time Metrics](/pt-br/documentacao/produtos/real-time-metrics/) da Azion para consultar dados consolidados por meio da GraphQL API relacionado ao acesso às aplicações protegida pelo Bot Protection, facilitando a identificação de padrões e *utilizando essa inteligência para otimizar suas regras*.

A função faz duas chamadas à GraphQL API, uma para recuperar dados de uso do host protegido e outra para buscar dados de uso do fingerprint que está fazendo a requisição. Em cada chamada, são retornadas as medianas dos últimos 15 minutos de uso da aplicação:

- `countryVariation`
- `customFieldVariation`
- `errorRate`
- `frequencyRate`
- `headRequestFrequencyRate`
- `postRequestFrequencyRate`
- `requestCount`
- `requestUriVariation`
- `uniqueRequestUriCount`
- `uniqueCountryCount`
- `uniqueCustomFieldCount`
- `uniqueRemoteAddressCount`

Usando esses dados e o fingerprint, a função valida se o uso pode ser identificado como um possível ataque, incluindo: força bruta (brute force), raspagem de sites (site scraping), rastreamento, preenchimento de credenciais (credential stuffing) e tomada de conta de conta (account takeover). Em caso de identificação de um ataque, a função executa a ação definida e também adiciona o tipo de ataque, além do tipo de bot (Bad bot, por exemplo), aos logs.

Além disso, é possível definir a **sensibilidade** da integração para analisar os dados e o fingerprint, sendo os valores possíveis:

- **Soft**: define uma criticidade menor.
- **Médio**: criticidade intermediária.
- **Hard**: define uma criticidade maior.

Para habilitar essa funcionalidade, inclua as seguintes variáveis no JSON Args:

```json
"metrics_disabled": false,
"metrics_logs": true,
"metrics_token": "azionb9d87fe9f5758c183bf2e63f15eb5aa5dfd",
"metrics_session_threshold": "hard",
```

Onde:

| Variável | Tipo | Obrigatório | Descrição |
|---|---|---|---|
| `metrics_disabled` | Boolean | Não | Quando ativado, impede a execução da validação contra a API. Valor padrão: `false` |
| `metrics_logs` | Boolean | Não | Quando habilitado, registra logs relacionados à execução da API no Real-Time Events da Azion. Valor padrão: `false` |
| `metrics_token` | String | Sim,<br/> com `metrics_bypass` habilitado | Personal token da Azion a ser usado em requisições da GraphQL API. Valor padrão: `"null"` |
| `metrics_session_threshold` | String | Não | Define a sensibilidade para analisar os dados e o fingerprint. Valores possíveis: `"soft"`, `"medium"` e `"hard"`. Valor padrão: `"soft"` |

:::note
Em caso de tempo de inatividade (downtime), atraso ou JSON Args inválido, a GraphQL API retornará uma mensagem de erro. Quando não há dados para o host e o fingerprint, a integração reconhece a requisição como legítima e a execução da função continua normalmente.
:::

#### Integre com um SIEM

Se você precisar dos logs do **Bot Protection**, você pode entrar em uma plataforma SIEM para obter estes dados. Para isso, na aba **Args**, atualize a função e insira os dados da conexão com o SIEM.

#### Exemplo de conexão SIEM

Quando os logs são enviados para o SIEM, você receberá as seguintes informações: 
```json
{
"siem_integration": true,
  "send_data_to_siem_when": "always",
  "siem_connection_args": {
    "host": "example.com",
    "uri": "/inspect/01g43ftztkqgvcr65pjwbr0227",
    "port": "443",
    "scheme": "https",
    "additional_headers": {
      "Authorization": "secret123"
      }
   }
}
```

Where:

| Variável | Tipo | Obrigatório | Descrição |
|---|---|---|---|
| `siem_integration` | Boolean | Não | Define se os dados da requisição devem ser postados em um endpoint externo. Valor padrão: `false` |
| `send_data_to_siem_when` | String | Não | Define quando os dados da requisição devem ser enviados ao endpoint externo (se `siem_integration` estiver habilitado). Valores possíveis: `always`, `deny`, `redirect`, `custom_html`, `drop`, `log`, `random_delay` e `hold_connection`. Saiba mais sobre a [configuração de actions](#configuracao-de-actions) |
| `siem_connection_args` | Tabela | Sim, <br/> com `siem_integration` habilitado | Os argumentos a serem usados no POST para o endpoint externo |
| `siem_connection_args.host` | String | Sim,<br/> com `siem_integration` habilitado | O host para onde os dados serão postados. Se este campo estiver vazio, a função será ignorada (bypass) |
| `siem_connection_args.uri` | String | Não | A URI onde os dados serão postados. Valor padrão: `/` |
| `siem_connection_args.port` | Número | Não | A porta para onde os dados serão POSTados. Valor padrão: `443` |
| `siem_connection_args.scheme` | String | Não | Define o esquema a ser utilizado no POST. Valor padrão: `https` |
| `siem_connection_args.additional_headers` | Tabela | Não | Cabeçalhos adicionais a serem enviados no POST. A função sempre enviará os seguintes cabeçalhos: `["Accept"] = "application/json"`, `["Content-Type"] = "application/json"` |

##### Log example

```json
{
  "geoip_region": "SP",
  "action": "deny",
  "asn": "396982",
  "request_id": "9581e2b51b5a082b12fed308f4eae564",
  "host": "xxxxxxx.map.azionedge.com",
  "classified": "bad bot",
  "geoip_country": "BR",
  "http_user_agent": "curl/7.87.0",
  "bot category": [
    "Bad Bot Signatures"
  ],
  "request_uri": "/a",
  "remote_addr": "34.95.175.91",
  "score": 8
}
```

---

import ContributorList from '~/components/ContributorList.astro'

**Contribuidores** <ContributorList>Contributor</ContributorList>
